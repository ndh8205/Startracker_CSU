function snr = calculate_peak_snr(img)
% CALCULATE_PEAK_SNR Peak SNR 계산 (별 센서 영상 전용)
%
% === 함수 개요 ===
% Peak SNR(피크 신호 대 잡음비)을 계산합니다.
% 영상에서 가장 밝은 별의 신호 세기와 배경 노이즈의 비율을 데시벨[dB]로 반환합니다.
%
% === 일반 PSNR과의 차이점 ===
% 표준 PSNR(Peak Signal-to-Noise Ratio)은 이론적 최대값(예: 8비트 영상의 255)을
% 기준으로 사용합니다. 그러나 별 센서 영상에서는 전체 픽셀의 99% 이상이 어두운
% 배경이므로, 이론적 최대값 대신 실제 가장 밝은 별의 신호를 기준으로 삼는 것이
% 물리적으로 더 의미 있습니다.
% 즉, Peak SNR = 가장 밝은 별의 실제 신호 / 배경 노이즈 입니다.
%
% === 수학적 정의 ===
%   Peak SNR [dB] = 20 * log10(peak_signal / noise_std)
%
%   여기서:
%     peak_signal = max(image) - median(image)  [ADU]
%                   (가장 밝은 픽셀 - 배경 수준 = 순수 별 신호)
%     noise_std   = std(background pixels)      [ADU]
%                   (배경 영역 픽셀들의 표준편차 = 노이즈 크기)
%
% === 20*log10 vs 10*log10 ===
% 여기서 20*log10을 사용하는 이유: SNR이 진폭비(amplitude ratio)이기 때문입니다.
% - 진폭비 (전압, ADU 등): 20 * log10(ratio) [dB]
% - 전력비 (power ratio):   10 * log10(ratio) [dB]
% 영상 픽셀값은 전력이 아닌 진폭(세기)이므로 20*log10을 사용합니다.
%
% === 별 센서 영상의 전형적인 값 ===
%   - 양호한 영상: 20 ~ 40 dB (별이 배경 대비 뚜렷하게 보임)
%   - 불량한 영상: < 15 dB   (노이즈에 별이 묻힘, 검출 어려움)
%
% === 입력 ===
%   img : 2D 영상 행렬 [ADU] (임의 자료형, 내부에서 double로 변환)
%         - 일반적으로 별 센서 영상 (배경 + 소수의 별 픽셀)
%
% === 출력 ===
%   snr : Peak SNR 값 [dB] (스칼라)
%         - 노이즈가 거의 없는 경우 100 dB 반환 (사실상 무한대)
%
% === 관련 함수 ===
%   calculate_snr.m - 기준 영상(reference) 대비 SNR 계산 (다른 방식)
%
% === 참고 ===
%   별 영역의 최대값과 배경 노이즈의 표준편차 비율로 계산됩니다.
%   배경 추정에 중앙값(median)을 사용하여 별 픽셀의 영향을 배제합니다.

% --- 자료형 변환 ---
% 입력 영상을 double형으로 변환하여 부동소수점 연산의 정밀도를 확보합니다.
% uint8, uint16 등의 정수형 입력도 안전하게 처리할 수 있습니다.
img = double(img);

% === 배경(Background) 수준 추정 ===
% --- 중앙값을 이용한 배경 추정 ---
% 중앙값(median)은 이상치(outlier)에 강건한 통계량입니다.
% 별 센서 영상에서 별이 차지하는 픽셀은 전체의 0.1% 미만이므로,
% 중앙값 ≈ 배경 수준(background level) [ADU]이 됩니다.
% (detect_stars_simple.m에서도 동일한 원리를 사용합니다.)
bg = median(img(:));

% === 배경 노이즈 표준편차 추정 ===
% --- 배경 영역 마스크 생성 ---
% bg + 10 [ADU] 미만인 픽셀만 배경으로 분류합니다.
% 매직 넘버 10 [ADU]의 의미:
%   - 배경 노이즈의 표준편차(sigma)가 보통 3~5 ADU이므로,
%     bg + 10 ≈ bg + 2~3*sigma 수준입니다.
%   - 이 임계값보다 밝은 픽셀은 별 픽셀일 가능성이 높으므로 제외합니다.
%   - 별 픽셀을 제외해야 순수한 배경 노이즈만 정확히 측정할 수 있습니다.
bg_mask = img < (bg + 10);

% --- 최소 표본 수 검증 ---
% 매직 넘버 100 [pixel]: 표준편차를 신뢰성 있게 계산하기 위한 최소 표본 수입니다.
%   - 통계적으로 N < 100인 표본의 표준편차는 불확실성이 큽니다.
%   - 일반적인 1280x720 영상의 경우, 배경 픽셀 수 ≈ 900,000+ 이므로
%     이 조건은 거의 항상 통과합니다.
%   - 만약 배경 픽셀이 100개 미만인 비정상 상황이면,
%     전체 픽셀의 표준편차를 대체값(fallback)으로 사용합니다.
if sum(bg_mask(:)) > 100
    noise_std = std(img(bg_mask));
else
    noise_std = std(img(:));
end

% === Peak 신호 계산 ===
% --- 배경 차감을 통한 순수 별 신호 추출 ---
% 순수 신호 = 최대 픽셀값 - 배경 수준 [ADU]
% 배경을 빼야 노이즈 바닥(noise floor) 위의 실제 별 밝기를 얻을 수 있습니다.
% 이 값은 영상에서 가장 밝은 별의 진폭(amplitude)에 해당합니다 [ADU].
peak_signal = max(img(:)) - bg;

% === SNR 계산 및 반환 ===
% --- 제로 노이즈 방지 (Division by zero guard) ---
% 매직 넘버 0.1 [ADU]: 노이즈가 사실상 0인지 판단하는 임계값입니다.
%   - noise_std < 0.1이면 영상에 노이즈가 거의 없는 상태입니다.
%     (예: 노이즈를 추가하지 않은 합성 영상)
%   - 이 경우 0으로 나누기를 방지하기 위해 100 [dB]을 반환합니다.
%   - 100 dB = 10^5 진폭비로, 사실상 "완벽한 신호"를 의미합니다.
if noise_std < 0.1
    snr = 100;
else
    % --- 데시벨 변환 ---
    % 진폭비를 데시벨[dB]로 변환합니다.
    % 20* (10*이 아닌 이유): 픽셀값은 진폭(amplitude) 단위이므로 20을 곱합니다.
    % 계산 예시: peak_signal=100 [ADU], noise_std=5 [ADU]
    %   → SNR = 20 * log10(100/5) = 20 * log10(20) = 26.0 [dB]
    snr = 20 * log10(peak_signal / noise_std);
end
end
