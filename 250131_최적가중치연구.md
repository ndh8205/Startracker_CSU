# OV4689 우주 환경 Bayer→Gray 최적 가중치 연구

> **날짜**: 2026-01-31
> **관련 스크립트**: `sub_main_2_optimal_weights.m`
> **결과 데이터**: `output/optimal_weights_result.mat`
> **관련 이슈**: 이미지 파이프라인 비효율 분석 (`250131_이미지파이프라인_비효율분석.md`)

---

## 1. 연구 목적

### 문제

기존 FPGA 이미지 파이프라인의 RGB→Gray 변환 공식은:

```
Y = (R + 2G + B) / 4    ← 인간 시각 기반 가중치
```

이 공식은 **인간의 눈이 녹색에 민감하다**는 사실 (ITU-R BT.601)에 근거합니다.
그러나 우주 별 추적기는 인간이 보는 것이 아니라, **별 신호의 SNR(신호대잡음비)을 최대화**하는 것이 목표입니다.

### 연구 질문

> Bayer 센서에서 직접 Grayscale로 변환할 때,
> R, G, B 채널에 각각 얼마의 가중치를 주어야 SNR이 최대인가?

---

## 2. 이론적 배경

### 2.1 별빛의 물리: 흑체복사

별은 온도에 따라 다른 색의 빛을 방출합니다 (흑체복사, Planck 법칙):

```
          파장 (nm)
  350     500     650     900
  ├───────┼───────┼───────┤
  ◄ 파랑     녹색    빨강 ►

  25,000K (B형) ■■■■■■■■░░░░    ← 파란쪽에 에너지 집중
  10,000K (A형) ░░■■■■■■■■░░    ← 전체적으로 고름
   5,800K (G형) ░░░░■■■■■■■■    ← 빨간쪽이 더 강함
   3,000K (M형) ░░░░░░░░■■■■    ← 적외선쪽에 집중
```

**핵심**: 대부분의 밝은 항해성(navigation star)은 G~A형(5,000~10,000K)이므로,
R 채널 신호가 B 채널보다 강합니다.

### 2.2 OV4689 센서의 분광 응답

OV4689 Bayer 필터의 채널별 감응 특성 (가우시안 근사):

```
  파장(nm)  350   400   450   500   550   600   650   700   750   800
            │     │     │     │     │     │     │     │     │     │
  B 채널    │     ░░░░▓▓████▓▓░░   │     │     │     │     │     │
            │     │  (피크 462nm)   │     │     │     │     │     │
  G 채널    │     │     │  ░░▓▓████████▓▓░░   │     │     │     │
            │     │     │     (피크 530nm)     │     │     │     │
  R 채널    │     │     │     │     │  ░░▓▓████████████▓▓░░│     │
            │     │     │     │     │     (피크 610nm)      │     │
```

| 채널 | 피크 파장 | 피크 QE | 반치폭 |
|------|----------|---------|--------|
| R    | 610 nm   | 46.7%   | ~100 nm |
| G    | 530 nm   | 51.1%   | ~80 nm  |
| B    | 462 nm   | 43.6%   | ~60 nm  |

**R 채널이 가장 넓은 범위를 감지** → 적분 신호량이 가장 큼

### 2.3 최적 가중치 이론 (Inverse Variance Weighting)

여러 측정값을 합칠 때 SNR을 최대화하는 수학적 방법:

```
각 채널의 신호: S_R, S_G, S_B
각 채널의 노이즈: σ_R, σ_G, σ_B

최적 가중치: w_i ∝ S_i / σ_i²

결합 SNR = √(Σ S_i² / σ_i²)
```

**직관적 설명**: 신호가 크고 노이즈가 작은 채널을 더 많이 쓰라는 뜻.

#### 노이즈 레짐에 따른 가중치 변화

| 레짐 | 조건 | 최적 가중치 | 설명 |
|------|------|-----------|------|
| **Shot noise 지배** | 밝은 별 (≤ 2등급) | w_i ≈ 1/3 (균등) | σ² ≈ S이므로 w ∝ S/S = 1 |
| **혼합** | 중간 별 (3~5등급) | 신호 비례 경향 | 두 노이즈가 비슷한 크기 |
| **Read noise 지배** | 어두운 별 (≥ 5등급) | w_i ∝ S_i | σ² ≈ σ_read²(상수)이므로 w ∝ S |

---

## 3. 연구 결과

### 3.1 채널별 신호 비율 (우주 환경)

G2형(태양형, 5800K) 별 기준, 채널별 신호 비율:

```
  R 채널: ████████████████████  46.4%    ← 가장 많은 광자 수집
  G 채널: ██████████████        33.2%
  B 채널: ████████              20.4%

  비율 = 1.39 : 1.00 : 0.61
```

**R > G > B** 순서로 신호량이 큼. 이는 OV4689의 넓은 R 필터 응답과
별빛의 스펙트럼 에너지 분포 때문.

### 3.2 최적 가중치 (핵심 결과)

```
╔═══════════════════════════════════════════════════════╗
║                                                       ║
║   최적 가중치 (우주, 전 스펙트럼 평균):                  ║
║                                                       ║
║     R = 0.4544                                        ║
║     G = 0.3345                                        ║
║     B = 0.2111                                        ║
║                                                       ║
║   FPGA 구현: (8R + 5G + 3B) >> 4  (/16 나눗셈)        ║
║                                                       ║
╚═══════════════════════════════════════════════════════╝
```

### 3.3 기존 방법과 비교

| 방법 | R 가중치 | G 가중치 | B 가중치 | 6등급 별 SNR | 비고 |
|------|---------|---------|---------|-------------|------|
| 기존 FPGA `(R+2G+B)/4` | 0.250 | 0.500 | 0.250 | 기준 (0%) | 인간 시각 기반 |
| 균등 `(R+G+B)/3` | 0.333 | 0.333 | 0.333 | **+7.9%** | 단순 |
| Green only | 0.000 | 1.000 | 0.000 | -39.5% | G채널만 |
| **최적 (본 연구)** | **0.454** | **0.335** | **0.211** | **+10.6%** | **SNR 최대** |

**핵심**: 기존 FPGA 공식 대비 6등급 어두운 별에서 **SNR 10.6% 개선**

### 3.4 별 온도별 최적 가중치 (등급 가중 평균)

| 별 유형 | 온도(K) | w_R | w_G | w_B |
|---------|--------|-----|-----|-----|
| M형(적색) | 3,000 | 0.629 | 0.260 | 0.111 |
| K형 | 4,000 | 0.542 | 0.304 | 0.155 |
| G후기 | 5,000 | 0.486 | 0.325 | 0.189 |
| **G2형(태양)** | **5,800** | **0.454** | **0.335** | **0.211** |
| F형 | 7,500 | 0.412 | 0.345 | 0.244 |
| A형(백색) | 10,000 | 0.378 | 0.350 | 0.272 |
| B후기 | 15,000 | 0.348 | 0.352 | 0.300 |
| B형(청색) | 25,000 | 0.327 | 0.353 | 0.320 |

**관찰**: 뜨거운 별(B형)일수록 균등 가중에 수렴, 차가운 별(M형)일수록 R 가중치 증가

### 3.5 노이즈 레짐 전환점

```
Read noise = 3 e⁻ → σ_read² = 9 e⁻²
전환 신호 = 9 e⁻ (= 144 ADU × gain)
전환 등급 ≈ 4.4등급 (우주 환경)

  0등급 ──── 2등급 ──── 4.4등급 ──── 6등급 ──── 7등급
  ◄── Shot noise 지배 ──►│◄── Read noise 지배 ──────►
      (균등 가중이 최적)    │   (신호 비례 가중이 최적)
                          │
                     전환점 (4.4등급)
```

---

## 4. FPGA 구현 방안

### 4.1 정수 근사 비교

FPGA에서는 부동소수점 연산을 피하고 정수 나눗셈(비트 시프트)을 사용:

| 근사 방식 | 수식 | R:G:B 비율 | 오차 | FPGA 자원 |
|-----------|------|-----------|------|----------|
| `/4` | `(2R+G+B)>>2` | 0.500:0.250:0.250 | ±18% | 최소 |
| `/8` | `(3R+3G+2B)>>3` | 0.375:0.375:0.250 | ±18% | 중간 |
| **`/16` (권장)** | **`(8R+5G+3B)>>4`** | **0.500:0.312:0.188** | **±11%** | 중간 |

### 4.2 FPGA RTL 구현 예시 (개념)

```verilog
// 최적 가중 Bayer→Gray (파이프라인 1 클럭)
// 입력: 8-bit R, G, B (CFA 보간 후 또는 2x2 블록에서 추출)
// 출력: 8-bit Gray
//
// Y = (8*R + 5*G + 3*B) >> 4
//
// 곱셈기 없이 시프트+덧셈으로 구현:
//   8*R = R << 3
//   5*G = (G << 2) + G
//   3*B = (B << 1) + B

wire [10:0] weighted_sum;
assign weighted_sum = {R, 3'b0}           // 8*R = R << 3
                    + {1'b0, G, 2'b0} + {3'b0, G}  // 5*G = 4G + G
                    + {2'b0, B, 1'b0} + {3'b0, B};  // 3*B = 2B + B

wire [7:0] gray_out;
assign gray_out = weighted_sum[10:4];     // >> 4 (비트 시프트)
```

---

## 5. 핵심 발견 요약

1. **Read noise 지배 영역(어두운 별, ≥5등급)에서 최적화 효과 최대**: 기존 FPGA 대비 +10.6% SNR
2. **Shot noise 지배 영역(밝은 별, ≤2등급)에서는 균등 가중과 차이 미미**: ~1% 이내
3. **별 온도에 따른 최적 가중치 변화는 상대적으로 작음**: 고정 가중치 하나로 전체 카탈로그 커버 가능
4. **R 채널 중시**: OV4689의 넓은 R 응답 + 대부분 별이 R에서 더 강한 신호 → R 가중치 최대
5. **기존 FPGA의 Green 과가중 문제**: (R+2G+B)/4는 인간 시각용이며, 별 추적에는 비최적
6. **rgb2gray.cpp GBR 순서 버그 가능성**: 실제로는 (G+2B+R)/4가 적용 중일 수 있음 → 별도 검증 필요

---

## 6. 우주 vs 지상 환경 비교

| 항목 | 지상 | 우주 |
|------|------|------|
| 대기 투과율 | 0.5~0.7 | **1.0** |
| 신호량 | 기준 | **~2배** |
| 암전류 | 0.1 e⁻/px/s (25°C) | **0.01 e⁻/px/s (-20°C)** |
| Read noise | 3 e⁻ | 3 e⁻ (동일) |
| 배경 노이즈 | 높음 (대기 산란) | **최소** |
| SNR (0등급) | 15.5 | **22.5** (+45%) |

---

## 7. 결론 및 권장사항

### 즉시 적용 가능

- `bayer_to_gray_direct.m`에 `'optimal'` 방법 추가 완료
- 기본 가중치: `[0.4544, 0.3345, 0.2111]`
- 사용법: `gray = bayer_to_gray_direct(bayer_raw, 'optimal');`

### FPGA 수정 시 적용

- **기존**: `(R + 2G + B) >> 2` (rgb2gray.cpp)
- **변경**: `(8R + 5G + 3B) >> 4` (최적)
- 추가 자원: 시프트+덧셈 (곱셈기 불필요), DSP 0개 추가
- CFA 제거 후 직접 Bayer→Gray 변환 시 적용 권장

### 추가 연구 필요

- [ ] OV4689 실제 분광 응답 데이터 확보 시 가중치 재계산
- [ ] rgb2gray.cpp GBR 순서 버그 실험적 검증
- [ ] 실제 별 이미지로 Centroid 정확도 비교 시뮬레이션

---

## 8. 파일 목록

| 파일 | 설명 |
|------|------|
| `sub_main_2_optimal_weights.m` | 연구 메인 스크립트 (실행하면 전체 분석 수행) |
| `core/bayer_to_gray_direct.m` | 'optimal' 방법 추가됨 |
| `output/optimal_weights_result.mat` | 결과 데이터 (가중치, SNR 테이블) |
| `output/fig1_spectra_channel_response.png` | 그래프: 스펙트럼 + 채널 응답 |
| `output/fig2_optimal_weights_by_magnitude.png` | 그래프: 등급별 최적 가중치 |
| `output/fig3_snr_comparison.png` | 그래프: 방법별 SNR 비교 |
| `output/fig4_noise_regime.png` | 그래프: 노이즈 레짐 분석 |

---

*최종 업데이트: 2026-01-31*
